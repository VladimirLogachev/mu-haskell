<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# language AllowAmbiguousTypes   #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# language DataKinds             #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# language FlexibleContexts      #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# language FlexibleInstances     #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# language MultiParamTypeClasses #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# language PolyKinds             #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# language ScopedTypeVariables   #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# language TypeApplications      #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# language TypeFamilies          #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# language TypeOperators         #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# language UndecidableInstances  #-}</span><span>
</span><a name="line-12"></a><span class="hs-comment">{-|
Description : Registry of schemas

A registry of schemas saves the different schemas
supported by an application. Since messages and
protocols may evolve, it's useful to keep an updated
view of the different shapes of data we can handle.

Examples of registries are found in
&lt;https://docs.confluent.io/current/schema-registry/index.html Kafka&gt;
and &lt;https://github.com/higherkindness/compendium Compendium&gt;.
-}</span><span>
</span><a name="line-24"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Mu.Schema.Registry</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-25"></a><span>  </span><span class="hs-comment">-- * Registry of schemas</span><span>
</span><a name="line-26"></a><span>  </span><a href="Mu.Schema.Registry.html#Registry"><span class="hs-identifier hs-type">Registry</span></a><span class="hs-special">,</span><span> </span><a href="Mu.Schema.Registry.html#fromRegistry"><span class="hs-identifier hs-var">fromRegistry</span></a><span>
</span><a name="line-27"></a><span>  </span><span class="hs-comment">-- * Terms without an associated schema</span><span>
</span><a name="line-28"></a><span class="hs-special">,</span><span> </span><a href="Mu.Schema.Interpretation.Schemaless.html#Term"><span class="hs-identifier hs-type">SLess.Term</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Mu.Schema.Interpretation.Schemaless.html#Field"><span class="hs-identifier hs-type">SLess.Field</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Mu.Schema.Interpretation.Schemaless.html#FieldValue"><span class="hs-identifier hs-type">SLess.FieldValue</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Kind</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Proxy</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.TypeLits</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><a href="Mu.Schema.Class.html"><span class="hs-identifier">Mu.Schema.Class</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><a href="Mu.Schema.Definition.html"><span class="hs-identifier">Mu.Schema.Definition</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Mu.Schema.Interpretation.Schemaless.html"><span class="hs-identifier">Mu.Schema.Interpretation.Schemaless</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SLess</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-comment">-- |&#160;A 'Registry' is defined as a map from</span><span>
</span><a name="line-41"></a><span class="hs-comment">--   version numbers to type-level schemas.</span><span>
</span><a name="line-42"></a><span class="hs-comment">--</span><span>
</span><a name="line-43"></a><span class="hs-comment">--   /Implementation note/: you __must__</span><span>
</span><a name="line-44"></a><span class="hs-comment">--   write newer schemas at the head of the</span><span>
</span><a name="line-45"></a><span class="hs-comment">--   'Registry'. Otherwise, older schemas</span><span>
</span><a name="line-46"></a><span class="hs-comment">--   take precedence during conversion.</span><span>
</span><a name="line-47"></a><span class="hs-keyword">type</span><span> </span><a name="Registry"><a href="Mu.Schema.Registry.html#Registry"><span class="hs-identifier">Registry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Mu.Schema.Definition.html#Mappings"><span class="hs-identifier hs-type">Mappings</span></a><span> </span><span class="hs-identifier hs-type">Nat</span><span> </span><a href="Mu.Schema.Definition.html#Schema%27"><span class="hs-identifier hs-type">Schema'</span></a><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">-- | Converts a schemaless term into a value</span><span>
</span><a name="line-50"></a><span class="hs-comment">--   by checking all the possible schemas in</span><span>
</span><a name="line-51"></a><span class="hs-comment">--   a 'Registry'.</span><span>
</span><a name="line-52"></a><span class="hs-comment">--</span><span>
</span><a name="line-53"></a><span class="hs-comment">--   /Implementation note/: schemas are checked</span><span>
</span><a name="line-54"></a><span class="hs-comment">--   __in the same order__ in which they appear</span><span>
</span><a name="line-55"></a><span class="hs-comment">--   in the 'Registry' definition.</span><span>
</span><a name="line-56"></a><span class="hs-identifier">fromRegistry</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679201267"><a href="#local-6989586621679201267"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679201268"><a href="#local-6989586621679201268"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679201269"><a href="#local-6989586621679201269"><span class="hs-identifier">w</span></a></a><span class="hs-operator">.</span><span> </span><a href="Mu.Schema.Registry.html#FromRegistry"><span class="hs-identifier hs-type">FromRegistry</span></a><span> </span><a href="#local-6989586621679201269"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679201267"><span class="hs-identifier hs-type">r</span></a><span> </span><a href="#local-6989586621679201268"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-57"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Mu.Schema.Interpretation.Schemaless.html#Term"><span class="hs-identifier hs-type">SLess.Term</span></a><span> </span><a href="#local-6989586621679201269"><span class="hs-identifier hs-type">w</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679201268"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-58"></a><a name="fromRegistry"><a href="Mu.Schema.Registry.html#fromRegistry"><span class="hs-identifier">fromRegistry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Mu.Schema.Registry.html#fromRegistry%27"><span class="hs-identifier hs-var">fromRegistry'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679201267"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-keyword">class</span><span> </span><a name="FromRegistry"><a href="Mu.Schema.Registry.html#FromRegistry"><span class="hs-identifier">FromRegistry</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679201255"><a href="#local-6989586621679201255"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-operator">*</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-operator">*</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679201256"><a href="#local-6989586621679201256"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Mu.Schema.Registry.html#Registry"><span class="hs-identifier hs-type">Registry</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679201257"><a href="#local-6989586621679201257"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-61"></a><span>  </span><a name="fromRegistry%27"><a href="Mu.Schema.Registry.html#fromRegistry%27"><span class="hs-identifier">fromRegistry'</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621679201256"><span class="hs-identifier hs-type">ms</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Mu.Schema.Interpretation.Schemaless.html#Term"><span class="hs-identifier hs-type">SLess.Term</span></a><span> </span><a href="#local-6989586621679201255"><span class="hs-identifier hs-type">w</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679201257"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">instance</span><span> </span><a href="Mu.Schema.Registry.html#FromRegistry"><span class="hs-identifier hs-type">FromRegistry</span></a><span> </span><a href="#local-6989586621679201265"><span class="hs-identifier hs-type">w</span></a><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679201266"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-64"></a><span>  </span><a name="local-8214565720323976163"><a href="Mu.Schema.Registry.html#fromRegistry%27"><span class="hs-identifier">fromRegistry'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-65"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679201258"><span class="hs-identifier hs-type">w</span></a><span class="hs-special">,</span><span> </span><a href="Mu.Schema.Class.html#FromSchema"><span class="hs-identifier hs-type">FromSchema</span></a><span> </span><a href="#local-6989586621679201258"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679201259"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679201260"><span class="hs-identifier hs-type">sty</span></a><span> </span><a href="#local-6989586621679201261"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-66"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Mu.Schema.Interpretation.Schemaless.html#CheckSchema"><span class="hs-identifier hs-type">SLess.CheckSchema</span></a><span> </span><a href="#local-6989586621679201259"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-special">(</span><a href="Mu.Schema.Definition.html#%3A%2F%3A"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="Mu.Schema.Definition.html#%3A%2F%3A"><span class="hs-operator hs-type">:/:</span></a><span> </span><a href="#local-6989586621679201260"><span class="hs-identifier hs-type">sty</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Mu.Schema.Registry.html#FromRegistry"><span class="hs-identifier hs-type">FromRegistry</span></a><span> </span><a href="#local-6989586621679201258"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679201262"><span class="hs-identifier hs-type">ms</span></a><span> </span><a href="#local-6989586621679201261"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>         </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Mu.Schema.Registry.html#FromRegistry"><span class="hs-identifier hs-type">FromRegistry</span></a><span> </span><a href="#local-6989586621679201258"><span class="hs-identifier hs-type">w</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Mu.Schema.Definition.html#%3A-%3E"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-special">'</span><a href="Mu.Schema.Definition.html#%3A-%3E"><span class="hs-operator hs-type">:-&gt;</span></a><span> </span><a href="#local-6989586621679201259"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679201262"><span class="hs-identifier hs-type">ms</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679201261"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-68"></a><span>  </span><a name="local-8214565720323976163"><a href="Mu.Schema.Registry.html#fromRegistry%27"><span class="hs-identifier">fromRegistry'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679201264"><a href="#local-6989586621679201264"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Mu.Schema.Interpretation.Schemaless.html#fromSchemalessTerm"><span class="hs-identifier hs-var">SLess.fromSchemalessTerm</span></a><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679201259"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679201258"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679201264"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><a href="Mu.Schema.Registry.html#fromRegistry%27"><span class="hs-identifier hs-var">fromRegistry'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679201262"><span class="hs-identifier hs-type">ms</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679201264"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-69"></a></pre></body></html>