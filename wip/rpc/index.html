<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF-8">

    

    <title>Mu-Haskell: Services and servers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Mu is a purely functional library for building microservices.">
    <meta name="keywords" content="functional-programming, monads, monad-transformers, functional-data-structure, swift, bow, fp-types, adt, free-monads, tagless-final, mtl, for-comprehension, category-theory">

    <meta property="og:image" content="/mu-haskell/wip/img/poster.png" />
    <meta property="og:title" content="Mu-Haskell: Services and servers" />
    <meta property="og:site_name" content="Mu-Haskell: Services and servers" />
    <meta property="og:url" content="https://higherkindess.io/mu-haskell" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="Mu is a purely functional library for building microservices." />
    <meta property="og:keywords" content="functional-programming, monads, monad-transformers, functional-data-structure, swift, bow, fp-types, adt, free-monads, tagless-final, mtl, for-comprehension, category-theory" />

    <meta name="twitter:text:description" content="Mu is a purely functional library for building microservices." />
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@47deg">
    <meta name="twitter:creator" content="@47deg">
    <meta name="twitter:image" content="/mu-haskell/wip/img/poster.png" />

    <meta property="github-info" data-github-owner="higherkindness" data-github-repo="mu-haskell" />

    <script defer src="/mu-haskell/wip/js/docs.js"></script>

    <!-- Favicon -->
    <link rel="shortcut icon" href="/mu-haskell/wip/img/favicon.png">

    <!-- mu-haskell docs css -->
    <link rel="stylesheet" type="text/css" href="/mu-haskell/wip/css/docs.css">
</head>

    <body>
        <div id="site-sidebar" class="site-sidebar">
  <div class="sidebar-brand">
    <a href="/mu-haskell/wip/" class="brand" title="Mu-Haskell">
      <img
        src="/mu-haskell/wip/img/nav-brand-white.svg"
        alt="Mu-Haskell"
        class="brand-wrapper"
      />
      <span>Mu-Haskell</span>
    </a>
    <button
      id="main-toggle"
      type="button"
      title="Close"
      class="button sidebar-toggle"
    >
      <span class="close"></span>
    </button>
  </div>
  <div class="sidebar-menu">
    
      

      
      
      
      

      
      
      

      

      

    <div class="sidebar-menu-item  ">
      
      <a
        href="/mu-haskell/wip/"
        class=""
        title="Start"
      >
        Start
      </a>
      
    </div>
    

      
      
      
      

      
      
      

      

      

    <div class="sidebar-menu-item  ">
      
      <a
        href="/mu-haskell/wip/intro/"
        class=""
        title="Introduction"
      >
        Introduction
      </a>
      
    </div>
    

      
      
      
      

      
      
      

      

      

    <div class="sidebar-menu-item  ">
       
      <a
        href="/mu-haskell/wip/schema/"
        title="Schemas"
        class="drop-nested"
      >
        Schemas
      </a>
      <div class="caret"></div>
      

      <div class="sub-menu">
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/registry/"
          title="Registry"
        >
          Registry
        </a>
        
      </div>
      
    </div>
    

      
      
      
      

      
      
      

      

      

    <div class="sidebar-menu-item active open">
       
      <a
        href="/mu-haskell/wip/rpc/"
        title="Services and servers"
        class="drop-nested"
      >
        Services and servers
      </a>
      <div class="caret"></div>
      

      <div class="sub-menu">
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/grpc/"
          title="gRPC"
        >
          gRPC
        </a>
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/stream/"
          title="Streams"
        >
          Streams
        </a>
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/db/"
          title="Databases"
        >
          Databases
        </a>
        
      </div>
      
    </div>
    

      
      
      
      

      
      
      

      

      

    <div class="sidebar-menu-item  ">
       
      <button
        type="button"
        title="Open Integrations"
        class="button drop-nested"
      >
        Integrations
      </button>
      <div class="caret"></div>
      

      <div class="sub-menu">
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/transformer/"
          title="Transformers"
        >
          Transformers
        </a>
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/middleware/"
          title="Middleware"
        >
          Middleware
        </a>
        
      </div>
      
    </div>
    
    
  </div>
</div>

        <main id="site-doc" class="site-doc">
    <div class="doc-header">
      <button
        id="menu-toggle"
        type="button"
        class="button doc-toggle"
        title="Toggle">
          <img src="/mu-haskell/wip/img/sidebar-icon-open.svg" alt="Toggle" title="Toggle">
      </button>

      <div class="link-container">
        
        <div id="version-dropdown" class="link-item">

    <button class="button link-like strong" onclick="openDropdown(event)" title="Version">
      
        <i class="nav-item-icon fa fa-lg " aria-hidden="true"></i>
        <span class="nav-item-text">Version</span>
      
    </button>

    <ul class="dropdown dropdown-content">
      
      <li class="dropdown-item">
        <a class="dropdown-item-link" title="Stable" href="https://higherkindness.io/mu-haskell/" target="_blank" rel="noopener noreferrer">
            <span>
              Stable
            </span>
        </a>
      </li>
      
      <li class="dropdown-item">
        <a class="dropdown-item-link" title="Next" href="https://higherkindness.io/mu-haskell/wip" target="_blank" rel="noopener noreferrer">
            <span>
              Next
            </span>
        </a>
      </li>
      
    </ul>

</div>

        
        <div id="api-docs-dropdown" class="link-item">

    <button class="button link-like strong" onclick="openDropdown(event)" title="API Docs">
      
        <i class="nav-item-icon fa fa-lg " aria-hidden="true"></i>
        <span class="nav-item-text">API Docs</span>
      
    </button>

    <ul class="dropdown dropdown-content">
      
      <li class="dropdown-item">
        <a class="dropdown-item-link" title="Stable" href="https://higherkindness.io/mu-haskell/haddock" target="_blank" rel="noopener noreferrer">
            <span>
              Stable
            </span>
        </a>
      </li>
      
      <li class="dropdown-item">
        <a class="dropdown-item-link" title="Next" href="https://higherkindness.io/mu-haskell/wip/haddock" target="_blank" rel="noopener noreferrer">
            <span>
              Next
            </span>
        </a>
      </li>
      
    </ul>

</div>

        
        <div class="link-item">
          <a href="https://github.com/higherkindness/mu-haskell" title="GitHub repo" target="_blank" rel="noopener noreferrer">
            <span class="strong">GitHub</span>
            <span id="stars-count"></span>
          </a>
        </div>
      </div>

    </div>
    <div class="doc-content">
        <h1 id="services-and-servers">Services and servers</h1>

<p>There are several formats in the wild used to declare service APIs, including <a href="https://avro.apache.org/docs/current/idl.html">Avro IDL</a>, <a href="https://grpc.io/">gRPC</a>, and <a href="https://swagger.io/specification/">OpenAPI</a>. <code class="highlighter-rouge">mu-rpc</code> abstract the commonalities into a single type-level format for declaring these services, building on the format-independent schema facilities of <code class="highlighter-rouge">mu-schema</code>. In addition, this package provides a generic notion of <em>server</em> of a service. One such server defines one behavior for each method in the service, but does not bother with (de)serialization mechanisms.</p>

<h2 id="importing-the-schema-and-the-service">Importing the schema and the service</h2>

<p>Let us begin with an example taken from the <a href="https://grpc.io/docs/quickstart/">gRPC Quickstart Guide</a>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">helloworld</span><span class="o">;</span>

<span class="n">service</span> <span class="nc">Greeter</span> <span class="o">{</span>
  <span class="n">rpc</span> <span class="nf">SayHello</span> <span class="o">(</span><span class="nc">HelloRequest</span><span class="o">)</span> <span class="n">returns</span> <span class="o">(</span><span class="nc">HelloReply</span><span class="o">)</span> <span class="o">{}</span>
<span class="o">}</span>

<span class="n">message</span> <span class="nc">HelloRequest</span> <span class="o">{</span> <span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="o">}</span>
<span class="n">message</span> <span class="nc">HelloReply</span> <span class="o">{</span> <span class="n">string</span> <span class="n">message</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="o">}</span>
</code></pre></div></div>

<p>As with our sibling <code class="highlighter-rouge">mu-schema</code> library, we use type-level techniques to represent the messages and services. Since the mapping from such a Protocol Buffers file into the require types is quite direct, you can just import them using one line (in addition to enabling the <code class="highlighter-rouge">TemplateHaskell</code> extension):</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{-# language TemplateHaskell #-}</span>

<span class="kr">import</span> <span class="nn">Mu.Quasi.GRpc</span>

<span class="n">grpc</span> <span class="s">"QuickstartSchema"</span> <span class="p">(</span><span class="n">const</span> <span class="s">"QuickstartService"</span><span class="p">)</span> <span class="s">"quickstart.proto"</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">grpc</code> function takes three arguments:</p>

<ul>
  <li>The first one defines the name of the schema type which is going to be generated, and which includes the declaration of all the messages in the file.</li>
  <li>The second one declares how to map the name of <em>each</em> service in the file (since more than one may appear) to the name of a Haskell type. In this case, we declare a constant name “QuickstartService”. But we could also use <code class="highlighter-rouge">(++ "Service")</code>, which would then give <code class="highlighter-rouge">GreeterService</code> as name for the only service in the file.</li>
  <li>The third argument is the route to the file <em>with respect to the project root</em>.</li>
</ul>

<p>This is everything you need to start using gRPC services and clients in Haskell!</p>

<h3 id="looking-at-the-resulting-code">Looking at the resulting code</h3>

<p>In order to use the library proficiently, we should look a bit at the code generated in the previous sample. A type-level description of the messages is put into the type <code class="highlighter-rouge">QuickstartSchema</code>. However, there is some code you still have to write by hand, namely the Haskell type which correspond to that schema. Using <code class="highlighter-rouge">mu-schema</code> facilities, this amounts to declaring a bunch of data types and including <code class="highlighter-rouge">deriving (Generic, ToSchema Maybe &lt;SchemaName&gt; "&lt;MessageType&gt;", FromSchema Maybe &lt;SchemaName&gt; "&lt;MessageType&gt;")</code> at the end of each of them.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{-# language PolyKinds, DataKinds, TypeFamilies #-}</span>
<span class="cp">{-# language MultiParamTypeClasses, TypeSynonymInstances, FlexibleInstances #-}</span>
<span class="cp">{-# language DeriveGeneric, DeriveAnyClass #-}</span>

<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Text</span> <span class="k">as</span> <span class="n">T</span>
<span class="kr">import</span> <span class="nn">GHC.Generics</span>

<span class="kr">import</span> <span class="nn">Mu.Adapter.ProtoBuf</span>
<span class="kr">import</span> <span class="nn">Mu.Schema</span>

<span class="c1">-- GENERATED</span>
<span class="kr">type</span> <span class="kt">QuickstartSchema</span>
  <span class="o">=</span> <span class="sc">'[</span><span class="err"> </span><span class="kt">'DRecord</span> <span class="s">"HelloRequest"</span>  <span class="sc">'[</span><span class="err"> </span><span class="kt">'FieldDef</span> <span class="s">"name"</span>    <span class="p">(</span><span class="kt">'TPrimitive</span> <span class="kt">T</span><span class="o">.</span><span class="kt">Text</span><span class="p">)</span> <span class="p">]</span>
     <span class="p">,</span> <span class="kt">'DRecord</span> <span class="s">"HelloResponse"</span> <span class="sc">'[</span><span class="err"> </span><span class="kt">'FieldDef</span> <span class="s">"message"</span> <span class="p">(</span><span class="kt">'TPrimitive</span> <span class="kt">T</span><span class="o">.</span><span class="kt">Text</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>

<span class="kr">type</span> <span class="kr">instance</span> <span class="kt">AnnotatedSchema</span> <span class="kt">ProtoBufAnnotation</span> <span class="kt">QuickstartSchema</span>
  <span class="o">=</span> <span class="sc">'[</span><span class="err"> </span><span class="kt">'AnnField</span> <span class="s">"HelloRequest"</span>  <span class="s">"name"</span>    <span class="p">(</span><span class="kt">'ProtoBufId</span> <span class="mi">1</span><span class="p">)</span>
     <span class="p">,</span> <span class="kt">'AnnField</span> <span class="s">"HelloResponse"</span> <span class="s">"message"</span> <span class="p">(</span><span class="kt">'ProtoBufId</span> <span class="mi">1</span><span class="p">)</span> <span class="p">]</span>

<span class="c1">-- TO BE WRITTEN</span>
<span class="kr">newtype</span> <span class="kt">HelloRequest</span>
  <span class="o">=</span> <span class="kt">HelloRequest</span> <span class="p">{</span> <span class="n">name</span> <span class="o">::</span> <span class="kt">Maybe</span> <span class="kt">T</span><span class="o">.</span><span class="kt">Text</span> <span class="p">}</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Generic</span>
           <span class="p">,</span> <span class="kt">ToSchema</span>   <span class="kt">Maybe</span> <span class="kt">QuickstartSchema</span> <span class="s">"HelloRequest"</span>
           <span class="p">,</span> <span class="kt">FromSchema</span> <span class="kt">Maybe</span> <span class="kt">QuickstartSchema</span> <span class="s">"HelloRequest"</span><span class="p">)</span>
<span class="kr">newtype</span> <span class="kt">HelloResponse</span>
  <span class="o">=</span> <span class="kt">HelloResponse</span> <span class="p">{</span> <span class="n">message</span> <span class="o">::</span> <span class="kt">Maybe</span> <span class="kt">T</span><span class="o">.</span><span class="kt">Text</span> <span class="p">}</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Generic</span>
           <span class="p">,</span> <span class="kt">ToSchema</span>   <span class="kt">Maybe</span> <span class="kt">QuickstartSchema</span> <span class="s">"HelloResponse"</span>
           <span class="p">,</span> <span class="kt">FromSchema</span> <span class="kt">Maybe</span> <span class="kt">QuickstartSchema</span> <span class="s">"HelloResponse"</span><span class="p">)</span>
</code></pre></div></div>

<p>The service declaration looks very similar to a schema declaration, but instead of records and enumerations you define <em>methods</em>. Each method has a name, a list of arguments, and a return type.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">import</span> <span class="nn">Mu.Rpc</span>

<span class="c1">-- GENERATED</span>
<span class="kr">type</span> <span class="kt">QuickstartService</span>
  <span class="o">=</span> <span class="kt">'Service</span> <span class="s">"Greeter"</span>
      <span class="sc">'[</span><span class="err"> </span><span class="kt">'Method</span> <span class="s">"SayHello"</span>
        <span class="sc">'[</span><span class="err"> </span><span class="kt">'ArgSingle</span> <span class="p">(</span><span class="kt">'FromSchema</span> <span class="kt">QuickstartSchema</span> <span class="s">"HelloRequest"</span><span class="p">)</span> <span class="p">]</span>
        <span class="p">(</span><span class="kt">'RetSingle</span> <span class="p">(</span><span class="kt">'FromSchema</span> <span class="kt">QuickstartSchema</span> <span class="s">"HelloResponse"</span><span class="p">))</span> <span class="p">]</span>
</code></pre></div></div>

<p>In order to support both <a href="https://avro.apache.org/docs/current/idl.html">Avro IDL</a> and <a href="https://grpc.io/">gRPC</a>, the declaration of the method arguments and return types is a bit fancier than you might expect:</p>

<ul>
  <li>Each <em>argument</em> declares the schema type used for serialization. Furthermore, the argument can be declared as <code class="highlighter-rouge">ArgSingle</code> (only one value is provided by the client) or <code class="highlighter-rouge">ArgStream</code> (a stream of values is provided).</li>
  <li>The <em>return types</em> gives the same two choices under the names <code class="highlighter-rouge">RetSingle</code> or <code class="highlighter-rouge">RetStream</code>, and additionally supports the declaration of methods which may raise exceptions using <code class="highlighter-rouge">RetThrows</code>, or methods which do not retun any useful information using <code class="highlighter-rouge">RetNothing</code>.</li>
</ul>

<p>Note that depending on the concrete implementation you use to run the server, one or more of these choices may not be available. For example, gRPC only supports one argument and return value, either single or streaming, but not exceptions.</p>

<h2 id="implementing-the-service">Implementing the service</h2>

<p>In order to implement the service, you have to define the behavior of each method by means of a <em>handler</em>. You can use Haskell types for your handlers, given that you had previously declared that they can be mapped back and forth the schema types using <code class="highlighter-rouge">ToSchema</code> and <code class="highlighter-rouge">FromSchema</code>. For example, the following is a handler for the <code class="highlighter-rouge">SayHello</code> method in <code class="highlighter-rouge">Greeter</code>:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sayHello</span> <span class="o">::</span> <span class="p">(</span><span class="kt">MonadServer</span> <span class="n">m</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kt">HelloRequest</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="kt">HelloResponse</span>
<span class="n">sayHello</span> <span class="p">(</span><span class="kt">HelloRequest</span> <span class="n">nm</span><span class="p">)</span> <span class="o">=</span> <span class="n">return</span> <span class="p">(</span><span class="kt">HelloResponse</span> <span class="p">(</span><span class="s">"hi, "</span> <span class="o">&lt;&gt;</span> <span class="n">nm</span><span class="p">))</span>
</code></pre></div></div>

<p>Notice the use of <code class="highlighter-rouge">MonadServer</code> in this case. This gives us the ability to:</p>

<ul>
  <li>Run arbitrary <code class="highlighter-rouge">IO</code> actions by using <code class="highlighter-rouge">liftIO</code>,</li>
  <li>Return an error code by calling <code class="highlighter-rouge">serverError</code>.</li>
</ul>

<p>Being polymorphic here allows us to run the same server in multiple back-ends. Furthermore, by enlarging the set of abilities required for our monad <code class="highlighter-rouge">m</code>, we can <a href="transformer.md">integrate with other libraries</a>, including logging and resource pools.</p>

<p>Since you can declare more than one method in a service, you need to join them into a <code class="highlighter-rouge">Server</code>. You do so by using <code class="highlighter-rouge">(:&lt;|&gt;:)</code> between each handler and ending the sequence with <code class="highlighter-rouge">H0</code>. In addition to the name of the service, <code class="highlighter-rouge">Server</code> has an additional parameter which records the types of the handlers. Since that list may become quite long, we can ask GHC to write it for us by using the <code class="highlighter-rouge">PartialTypeSignatures</code> extension and writing an underscore <code class="highlighter-rouge">_</code> in that position.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{-# language PartialTypeSignatures #-}</span>

<span class="n">quickstartServer</span> <span class="o">::</span> <span class="p">(</span><span class="kt">MonadServer</span> <span class="n">m</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kt">ServerT</span> <span class="kt">Maybe</span> <span class="kt">QuickstartService</span> <span class="n">m</span> <span class="kr">_</span>
<span class="n">quickstartServer</span> <span class="o">=</span> <span class="kt">Server</span> <span class="p">(</span><span class="n">sayHello</span> <span class="o">:&lt;|&gt;:</span> <span class="kt">H0</span><span class="p">)</span>
</code></pre></div></div>

    </div>
</main>

    </body>
</html>
